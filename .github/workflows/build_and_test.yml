name: Build and Test (Makefile + Docker)

on:
  push:
    paths:
      # Trigger on changes to relevant files
      - 'src/backend/**'
      - 'src/**'
      - '.github/workflows/build_and_test.yml'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Dockerfile'
      - 'Makefile'
      - 'deploy.sh'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # --- Build using Makefile ---
      - name: Build Docker Image and Extract Artifacts
        id: make_build
        run: |
          echo "Building with Makefile..."
          make build
          echo "Build complete!"

      - name: Verify Build Artifacts
        run: |
          echo "Verifying build artifacts..."
          ls -lh build/binaries/ || echo "No binaries found"
          ls -lh build/gateware/ || echo "No gateware found"
          if [ -f build/build-info.txt ]; then
            echo "Build Info:"
            cat build/build-info.txt
          fi

      # --- Run Tests inside Docker ---
      - name: Run Tests
        run: make test
        continue-on-error: true

      - name: Generate code coverage (Tarpaulin)
        run: |
          echo "Generating code coverage inside Docker..."
          docker run --rm -v ${{ github.workspace }}:/work amaranth-cynthion \
            sh -c "cargo install cargo-tarpaulin && \
                   cargo tarpaulin --out Xml --output-dir coverage \
                   --exclude-files src/usb.rs \
                   --verbose -- --test-threads=1" || echo "Tarpaulin failed, proceeding..."
          # Copy coverage out if it exists
          if [ -f coverage/cobertura.xml ]; then
            echo "Coverage report generated successfully"
          fi

      - name: Upload coverage report artifact
        if: hashFiles('Cargo.toml') != '' && hashFiles('coverage/cobertura.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: coverage/ # Tarpaulin ran natively, output is directly here
          if-no-files-found: warn

      - name: Upload coverage to Codecov
        if: hashFiles('Cargo.toml') != '' && hashFiles('coverage/cobertura.xml') != ''
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/cobertura.xml
          fail_ci_if_error: false

      # --- Artifact Packaging and Release ---
      - name: Package Artifacts
        id: package
        run: |
          echo "Artifacts are already in build/ directory from make build"
          echo "Packaged files:"
          find build/ -type f -ls
          echo "artifact_path=build" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            build/binaries/
            build/gateware/
            build/build-info.txt
          if-no-files-found: warn
